<%= form_tag plan_path, :method => (@plan.nil? or @plan.id.nil? ? :post : :put), :id => 'account_plan', :class => 'someform' do |p| %>

  <div class="admin-center upgrade">

    <!-- LEFT CONTENT -->
    <div class="content-left upgrade">
      <% if params[:cc] != "update" and flash[:cc] != "update" %>
        <div class="admin-stripes-box" style="width:415px;padding-top:15px;padding-bottom:0px;margin-bottom:25px;">	
          <% if @plan_templates.empty? %>
            For more messages, please contact <%= link_to 'Tatango', contact_path, :target => "_blank" %>.
          <% else %>
            <div class="form-header">
              <h2>1. Select a Plan</h2>
			  <p style="font-size:15px">All plans come with unlimited text messaging and keywords/campaigns.</p>
            </div>
						<fieldset>
							<legend>Select a plan</legend>
							
							<div class="somebox" style="width:410px;">

								<table class="selectplan" summary="Select a plan">
									<thead>
										<tr>
											<th style="width:220px">SUBSCRIBERS</th>
											<th style="width:130px;text-align:right;background-position: -247px 0;">MONTHLY PRICE</th>
										</tr>
									</thead>
									<tbody>
                    <% 
                      check_plan = true
                      @plan_templates.reverse.each_with_index{ |pt, i|
                        lower_plan = (@plan && pt.price < @plan.price.dollars)
                      %>
                      <tr>
                        <td class="first<% if lower_plan %> passive<% end %>">
                          <label>
                            <input type="radio" class="plan_select" name="plan" value="<%= pt.id %>"<% if lower_plan %> disabled<% elsif check_plan or @plan_template.id == pt.id %> checked<% end %> /> 
                            <span>
                              <% if i == 0 %>
                                0
                              <% else %>
                                <%= number_with_delimiter(@plan_templates.reverse[i-1].subscribers+1) %>
                              <% end %>
                              - <%= number_with_delimiter(pt.subscribers) %>
                            </span>
                          </label>
                        </td>
                        <td class="second<% if lower_plan %> passive<% end %>">
                          <%= number_to_currency(pt.price, :precision => 0) %>
                        </td>
                      </tr>
                    <%
                        if !lower_plan and check_plan
                          check_plan = false
                        end
                      } %>
										<tr>
											<td class="first last"> <span style="padding-left:18px">100,001+</span></td>
											<td class="second last"><a href="javascript:;" onclick="SnapABug.startLink();">Contact Us</a></td>
										</tr>
									</tbody>
								</table>
								
							</div>
							
						</fieldset>
          <% end %>
        </div>
      <% end %>
    </div>
    <!-- #END of left content -->


    <!-- RIGHT CONTENT -->
    <div class="content-right upgrade">

      <div class="admin-stripes-box" style="width:395px;padding-top:15px;padding-bottom:153px;margin-bottom:25px;">		
        <fieldset>
          <legend>Select the amount of subscribers you need</legend>
          <% if @plan.nil? or @plan.id.nil? or current_user.canceled? or @plan.subscription.nil? or !@plan.subscription.attributes.has_key?("credit_card") or params[:cc] == 'update' or flash[:cc] == 'update' then %>
            <h2><% if params[:cc] != "update" and flash[:cc] != 'update' %>2. <% end %>Enter Your Billing Information</h2>
            <div class="validationError">
              <label class="error">
                <%= flash[:error] %>
              </label>
            </div>
            <%= fields_for :credit_card do |cc| %>
              <div class="somebox nopadding" style="margin-top:20px;width:100%;padding-bottom:15px">
                <p class="semibold" style="font-size:15px;padding-bottom:5px;">Card Number*</p>
                <%= cc.text_field :number %><span class="end"></span>
                <div class="signupError"></div>
              </div>
              <div class="somebox nopadding" style="width:195px;padding-bottom:15px;height:67px;">
                <p class="semibold" style="font-size:15px;padding-bottom:5px;">Expiration Date*</p>
                <%= select_month (defined?(@credit_card) ? @credit_card.month.to_i : Date.today), {:prefix => 'credit_card', :use_month_numbers => true}, :style => 'width:70px;' %><span class="end" style="margin-right:10px"></span>
                <%= select_year (defined?(@credit_card) ? @credit_card.year.to_i : Date.today), {:prefix => 'credit_card', :start_year => Date.today.year, :end_year => Date.today.year + 20}, :style => 'width:70px;' %><span class="end"></span>
                <div class="signupError"></div>
              </div>
              <div class="somebox nopadding" style="width:167px;padding:0 0 15px 33px;height:67px;">
                <p class="semibold" style="font-size:15px;padding-bottom:5px;">Zip Code*</p>
                <%= cc.text_field :zip, :class => 'short required', :style => 'width: 140px;' %><span class="end"></span>
                <div class="signupError"></div>
              </div>
            <% end %>
          <% else %>
            <h2>2. Confirm Plan</h2>
          <% end %>
          <% if params[:cc] != "update" and flash[:cc] != "update" %>
            <div class="somebox nopadding" style="width:100%;padding-bottom:0px;margin-bottom:0;background:none;">
              <div id="hasPromoCode">
                <a href="javascript:;" onclick="$('#promoCodeForm').show();$('#hasPromoCode').hide();" class="blue" style="float:right;">Promotion Code?</a>
              </div>
              <div id="promoCodeForm" style="display:none;">
                <p class="semibold" style="font-size:15px;padding-bottom:5px;">Promotion Code</p>
                <%= text_field_tag :coupon_code, (@plan.coupon_code if @plan and @plan.coupon_code.present?), :class => 'short' %><span class="end"></span>
              </div>
            </div>
              <div class="upgrade-right-txt">
              <% if @plan_templates.empty? and params[:cc] != 'update' and flash[:cc] != "update" %>
                <p>For more subscribers, please contact <%= link_to 'Tatango', 'http://tatango.zendesk.com/anonymous_requests/new', :target => "_blank" %>.</p>
              <% else %>
                <% if @plan.nil? or @plan.id.nil? or current_user.expired? or current_user.canceled? %>
                  <p>
                    You will be billed <b>$<span class="plan_price"><%= @plan_templates.reverse.first.price.dollars.to_i %></span>/month</b> for the Tatango service. Tatango will charge your credit card today and then monthly starting on <%= (Time.now + 1.month).strftime("%B %d, %Y") %>.
                  </p>
                  <p>
                    At anytime during your subscription, you are able to cancel your account. When you cancel your subscription, you will no longer be billed for the service.
                  </p>
                <% else %>
                  <p>Once you click the button below you'll be upgraded to your new plan. You'll be charged the new rate of <strong>$<span class="plan_price"><%= @plan_templates.reverse.first.price.dollars.to_i %></span>/month</strong> starting on your next bill. </p>

                  <p>At anytime during your subscription, you are able to cancel your account. When you cancel your subscription, you will no longer be billed for the service.</p>

                  <% if @plan and @plan.id and @plan.state == 'active' %>
                    <p>To downgrade, please contact <%= link_to 'Tatango', 'https://tatango.zendesk.com/anonymous_requests/new', :target => "_blank" %>.</p>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          <% end %>
          <div class="input-green-btn">
            <label><input type="submit" value="<%= (params[:cc] != "update" and flash[:cc] != "update") ? "Upgrade Account" : "Update Information" %>" /></label>
          </div>
        </fieldset>
      </div>
    </div>
  </div>
<% end %>

<% javascript 'jquery.validate' %>

<script type="text/javascript">
var planPrices = new Array();
<% for pt in @plan_templates %>
planPrices['<%= pt.id %>'] = <%= pt.price %>;
<% end %>

function update_plan_texts() {
  sum = planPrices[$('.plan_select:checked').val()];

  $('span.plan_price').html( sum );
}

$('.plan_select').change(function(){
  update_plan_texts();
});
update_plan_texts();
</script>

<script type="text/javascript">
<% if current_user.delinquent? %>
  $(document).ready(function(){
    $.openDOMWindow({ 
        windowSourceID: '#delinquent_popup',
        height:500,
        width:500,
        windowPadding:0,
        overlayOpacity:'60',
        windowBGColor:'transparent',
        borderSize:'0',
        positionType:'centerTop'
    });
  });
<% elsif current_user.expired? or current_user.canceled? %>
  $(document).ready(function(){
    $.openDOMWindow({ 
        windowSourceID: '#trial_expired_popup',
        height:500,
        width:500,
        windowPadding:0,
        overlayOpacity:'60',
        windowBGColor:'transparent',
        borderSize:'0',
        positionType:'centerTop'
    });
  });
<% end %>
</script>

<div id="trial_expired_popup" class="account_popup" style="display: none;">
  <div class="pop-up-window-admin">
    <div class="pop-up-window-top-admin">
      <h1>Account Expired</h1>
      <a class="pop-up-close" onclick="jQuery('.defaultDOMWindow').closeDOMWindow()" title="Close"></a>
    </div>
    <div class="pop-up-content-admin">
      <div class="center">
        <p class="normal">
          This is a notice that your account has expired. Please select a subscription plan to continue to use the Tatango service.
        </p>
        <p class="normal">
          If you have questions about updating your billing information, please contact Tatango support.
        </p>
      </div>
    </div>
  </div>
</div>

<div id="delinquent_popup" class="account_popup" style="display: none;">
  <div class="pop-up-window-admin">
    <div class="pop-up-window-top-admin">
      <h1>Credit Card Declined</h1>
      <a class="pop-up-close" onclick="jQuery('.defaultDOMWindow').closeDOMWindow()" title="Close"></a>
    </div>
    <div class="pop-up-content-admin">
      <div class="center">
        <p class="normal">
          Your credit card 
            <% if @account.plan and @account.plan.subscription and @account.plan.subscription.respond_to?(:credit_card) %>
              (<%= @account.plan.subscription.credit_card.try(:masked_card_number) %>)
            <% end %>
            on file here at Tatango has been declined. Please update your billing information to continue to use the Tatango service.
        </p>
        <p class="normal">
          If you have questions about updating your billing information, please contact Tatango support.
        </p>
      </div>
    </div>
  </div>
</div>
